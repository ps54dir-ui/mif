# 사업자 상태 조회 API - 런타임 오류 분석

## 1. 런타임 오류 가능성 목록

### 1.1 입력 관련
- [ ] request.json() 파싱 실패 (잘못된 JSON 형식)
- [ ] businessNumber가 null/undefined
- [ ] businessNumber가 문자열이 아님 (숫자, 객체 등)
- [ ] businessNumber가 빈 문자열
- [ ] businessNumber가 10자리가 아님
- [ ] businessNumber에 숫자가 아닌 문자가 포함

### 1.2 환경변수 관련
- [ ] NEXT_PUBLIC_SUPABASE_URL 없음
- [ ] SUPABASE_SERVICE_ROLE_KEY 없음
- [ ] NTS_SERVICE_KEY 없음

### 1.3 외부 의존성 관련
- [ ] Supabase 연결 실패 (네트워크 오류)
- [ ] Supabase 인증 실패
- [ ] Supabase 테이블 없음 (business_status_cache)
- [ ] Supabase RLS 정책으로 인한 접근 거부
- [ ] 국세청 API 네트워크 타임아웃
- [ ] 국세청 API 인증 실패
- [ ] 국세청 API 응답 형식 변경

### 1.4 데이터 처리 관련
- [ ] 캐시 조회 시 데이터 타입 불일치
- [ ] 날짜 파싱 실패 (expires_at)
- [ ] 해시 생성 실패 (crypto 모듈 문제)
- [ ] JSON 직렬화 실패

### 1.5 시스템 리소스 관련
- [ ] 메모리 부족
- [ ] 요청 타임아웃
- [ ] 동시 요청 과다로 인한 성능 저하

## 2. 예상 실패 시나리오 (5개 이상)

### 시나리오 1: 잘못된 JSON 요청
**상황**: 클라이언트가 잘못된 형식의 JSON을 전송
**영향**: request.json() 파싱 실패로 전체 API 실패
**방어**: try-catch로 파싱 에러 처리, 기본값 제공

### 시나리오 2: Supabase 연결 실패
**상황**: 네트워크 문제 또는 Supabase 서비스 장애
**영향**: 캐시 조회/저장 불가
**방어**: 캐시 조회 실패 시 MOCK 응답으로 fallback

### 시나리오 3: 환경변수 미설정
**상황**: .env 파일에 필요한 환경변수가 없음
**영향**: Supabase 클라이언트 생성 불가
**방어**: 환경변수 체크 후 MOCK 모드로 전환

### 시나리오 4: 국세청 API 타임아웃
**상황**: 국세청 API 응답이 30초 이상 지연
**영향**: API 호출 실패
**방어**: 타임아웃 설정 및 실패 시 MOCK 응답

### 시나리오 5: 잘못된 사업자등록번호 형식
**상황**: 사용자가 "123-45-67890-11" 같은 잘못된 형식 입력
**영향**: 검증 실패
**방어**: 엄격한 정규식 검증 및 명확한 에러 메시지

### 시나리오 6: 캐시 데이터 손상
**상황**: DB에 저장된 캐시 데이터가 손상되어 파싱 불가
**영향**: 캐시 조회 실패
**방어**: try-catch로 감싸고, 실패 시 API 호출로 fallback

### 시나리오 7: 동시 요청 과다
**상황**: 동일한 사업자등록번호로 동시에 여러 요청
**영향**: 성능 저하, 중복 API 호출
**방어**: (향후 추가) 요청 디바운싱 또는 큐잉

## 3. 취약점 분석

### 현재 코드의 취약점
1. **타입 안정성 부족**: any 타입 사용
2. **에러 처리 일관성 부족**: 일부는 에러 반환, 일부는 MOCK 반환
3. **로깅 부족**: 디버깅이 어려움
4. **타임아웃 미설정**: 외부 API 호출 시 무한 대기 가능
5. **입력 검증 불완전**: 엣지 케이스 미처리
